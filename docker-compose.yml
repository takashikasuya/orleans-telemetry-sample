# Orleans Telemetry Sample - Docker Compose Configuration
#
# IMPORTANT: RDF Seed File Synchronization
# ----------------------------------------
# Both 'silo' and 'publisher' services use the same RDF seed file (data/seed-complex.ttl)
# to ensure that:
#   1. SiloHost initializes the building graph structure with device/point definitions
#   2. Publisher generates telemetry for devices that match those definitions
#
# If you modify or replace the RDF seed file, UPDATE BOTH SERVICE CONFIGURATIONS
# in this file to maintain consistency between the data model and telemetry data.

services:
  mq:
    image: rabbitmq:3-management
    hostname: mq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  silo:
    build:
      context: .
      dockerfile: ./Dockerfile.dotnet
      args:
        PROJECT: src/SiloHost
    depends_on:
      - mq
    environment:
      RABBITMQ_HOST: mq
      RDF_SEED_PATH: /seed/seed.ttl
      TENANT_ID: t1
      Orleans__AdvertisedIPAddress: silo
      Orleans__SiloPort: "11111"
      Orleans__GatewayPort: "30000"
    ports:
      - "11111:11111"
      - "30000:30000"
    volumes:
      - ./data/seed-complex.ttl:/seed/seed.ttl:ro
      - ./data/graph-uploads:/uploads

  api:
    build:
      context: .
      dockerfile: ./Dockerfile.dotnet
      args:
        PROJECT: src/ApiGateway
    depends_on:
      - silo
    environment:
      OIDC_AUTHORITY: ${OIDC_AUTHORITY:-http://mock-oidc:8080/default}
      OIDC_AUDIENCE: ${OIDC_AUDIENCE:-default}
      Orleans__GatewayHost: silo
      Orleans__GatewayPort: "30000"
      ASPNETCORE_URLS: http://+:80
    ports:
      - "8080:80"

  admin:
    build:
      context: .
      dockerfile: ./Dockerfile.dotnet
      args:
        PROJECT: src/AdminGateway
    depends_on:
      - silo
    environment:
      OIDC_AUTHORITY: ${OIDC_AUTHORITY:-http://mock-oidc:8080/default}
      OIDC_AUDIENCE: ${OIDC_AUDIENCE:-default}
      Orleans__GatewayHost: silo
      Orleans__GatewayPort: "30000"
      ASPNETCORE_URLS: http://+:80
      ADMIN_GRAPH_UPLOAD_DIR: /uploads
    ports:
      - "8082:80"
    volumes:
      - ./data/graph-uploads:/uploads

  telemetry-client:
    build:
      context: .
      dockerfile: ./Dockerfile.dotnet
      args:
        PROJECT: src/TelemetryClient
    depends_on:
      - api
    environment:
      TelemetryClient__ApiGatewayBaseAddress: http://api:80
      ASPNETCORE_URLS: http://+:80
    ports:
      - "8083:80"

  publisher:
    build:
      context: .
      dockerfile: ./Dockerfile.dotnet
      args:
        PROJECT: src/Publisher
    depends_on:
      - mq
    environment:
      RABBITMQ_HOST: mq
      TENANT: t1
      RDF_SEED_PATH: /seed/seed.ttl
    volumes:
      - ./data/seed-complex.ttl:/seed/seed.ttl:ro

  # Mock OIDC provider for local development
  mock-oidc:
    image: ghcr.io/navikt/mock-oauth2-server:latest
    ports:
      - "8081:8080"
