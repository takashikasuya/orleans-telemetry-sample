# Orleans Telemetry Sample - Docker Compose Configuration
#
# IMPORTANT: RDF Seed File Synchronization
# ----------------------------------------
# Both 'silo' and 'publisher' services use the same RDF seed file (seed-complex.ttl)
# to ensure that:
#   1. SiloHost initializes the building graph structure with device/point definitions
#   2. Publisher generates telemetry for devices that match those definitions
#
# If you modify or replace the RDF seed file, UPDATE BOTH SERVICE CONFIGURATIONS
# in this file to maintain consistency between the data model and telemetry data.

services:
  mq:
    image: rabbitmq:3-management
    hostname: mq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

  silo:
    build:
      context: ./src/SiloHost
      dockerfile: ../../Dockerfile.dotnet
      args:
        PROJECT: SiloHost
    depends_on:
      - mq
    environment:
      RABBITMQ_HOST: mq
      RDF_SEED_PATH: /seed/seed.ttl
      TENANT_ID: t1
      Orleans__AdvertisedIPAddress: silo
      Orleans__SiloPort: "11111"
      Orleans__GatewayPort: "30000"
    ports:
      - "11111:11111"
      - "30000:30000"
    volumes:
      - ./src/Telemetry.E2E.Tests/seed-complex.ttl:/seed/seed.ttl:ro

  api:
    build:
      context: ./src/ApiGateway
      dockerfile: ../../Dockerfile.dotnet
      args:
        PROJECT: ApiGateway
    depends_on:
      - silo
    environment:
      OIDC_AUTHORITY: ${OIDC_AUTHORITY:-http://mock-oidc:8080/default}
      OIDC_AUDIENCE: ${OIDC_AUDIENCE:-default}
      Orleans__GatewayHost: silo
      Orleans__GatewayPort: "30000"
      ASPNETCORE_URLS: http://+:80
    ports:
      - "8080:80"

  admin:
    build:
      context: ./src/AdminGateway
      dockerfile: ../../Dockerfile.dotnet
      args:
        PROJECT: AdminGateway
    depends_on:
      - silo
    environment:
      OIDC_AUTHORITY: ${OIDC_AUTHORITY:-http://mock-oidc:8080/default}
      OIDC_AUDIENCE: ${OIDC_AUDIENCE:-default}
      Orleans__GatewayHost: silo
      Orleans__GatewayPort: "30000"
      ASPNETCORE_URLS: http://+:80
    ports:
      - "8082:80"

  telemetry-client:
    build:
      context: ./src/TelemetryClient
      dockerfile: ../../Dockerfile.dotnet
      args:
        PROJECT: TelemetryClient
    depends_on:
      - api
    environment:
      TelemetryClient__ApiGatewayBaseAddress: http://api:80
      ASPNETCORE_URLS: http://+:80
    ports:
      - "8083:80"

  publisher:
    build:
      context: ./src/Publisher
      dockerfile: ../../Dockerfile.dotnet
      args:
        PROJECT: Publisher
    depends_on:
      - mq
    environment:
      RABBITMQ_HOST: mq
      TENANT: t1
      RDF_SEED_PATH: /seed/seed.ttl
    volumes:
      - ./src/Telemetry.E2E.Tests/seed-complex.ttl:/seed/seed.ttl:ro

  # Mock OIDC provider for local development
  mock-oidc:
    image: ghcr.io/navikt/mock-oauth2-server:latest
    ports:
      - "8081:8080"
