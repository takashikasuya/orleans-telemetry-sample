@page "/"
@inject AdminMetricsService Metrics
@using System.Collections.Generic

<section class="admin-header">
    <div>
        <p class="eyebrow">Orleans Telemetry - Admin Console</p>
        <h1>Cluster Overview</h1>
    </div>
    <button class="refresh-button" @onclick="RefreshAsync">Refresh</button>
</section>

@if (_loading)
{
    <p class="status">Loading dashboard data...</p>
}
else if (_error is not null)
{
    <p class="status error">@_error</p>
}
else
{
    <section class="overview">
        <article>
            <h2>Ingest</h2>
            <p>Batch size: @_ingest?.BatchSize</p>
            <p>Channel capacity: @_ingest?.ChannelCapacity</p>
            <div class="tag-row">
                <strong>Connectors</strong>
                @if (_ingest?.EnabledConnectors.Length > 0)
                {
                    @foreach (var connector in _ingest.EnabledConnectors)
                    {
                        <span class="tag">@connector</span>
                    }
                }
                else
                {
                    <span class="tag muted">None</span>
                }
            </div>
            <div class="tag-row">
                <strong>Event sinks</strong>
                @if (_ingest?.EnabledSinks.Length > 0)
                {
                    @foreach (var sink in _ingest.EnabledSinks)
                    {
                        <span class="tag">@sink</span>
                    }
                }
                else
                {
                    <span class="tag muted">None</span>
                }
            </div>
        </article>
        <article>
            <h2>Storage</h2>
            @if (_storage is not null)
            {
                <p>Stage: @_storage.Stage.FileCount files</p>
                <p>Parquet: @_storage.Parquet.FileCount files</p>
                <p>Index: @_storage.Index.FileCount files</p>
            }
            else
            {
                <p>Storage stats unavailable.</p>
            }
        </article>
        <article>
            <h2>Clients</h2>
            <p>Silos: @_silos.Length</p>
            <p>Total clients: @(_silos.Sum(s => s.ClientCount))</p>
        </article>
    </section>

    <section>
        <h2>Activation Explorer (@_grains.Length types)</h2>
        @if (_grains.Length == 0)
        {
            <p class="status muted">No grain activations yet.</p>
        }
        else
        {
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th>Grain Type</th>
                            <th>Activations</th>
                            <th>Silos</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var grain in _grains)
                        {
                            <tr>
                                <td>@grain.GrainType</td>
                                <td class="numeric">@grain.ActivationCount</td>
                                <td>@string.Join(", ", grain.Silos)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </section>

    <section>
        <h2>Client Connections</h2>
        @if (_silos.Length == 0)
        {
            <p class="status muted">No active silos detected.</p>
        }
        else
        {
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th>Silo</th>
                            <th>Status</th>
                            <th>Clients</th>
                            <th>Activations</th>
                            <th>CPU (%)</th>
                            <th>Memory (used / max)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var silo in _silos)
                        {
                            <tr>
                                <td>@silo.SiloAddress</td>
                                <td>@silo.Status</td>
                                <td class="numeric">@silo.ClientCount</td>
                                <td class="numeric">@silo.ActivationCount</td>
                                <td>@FormatPercent(silo.CpuUsagePercentage)</td>
                                <td>@FormatMemoryUsage(silo.MemoryUsageBytes, silo.MaximumAvailableMemoryBytes)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </section>

    <section>
        <h2>Storage Buckets</h2>
        <div class="tier-grid">
            @if (_storage is not null)
            {
                @foreach (var tier in new[] { _storage.Stage, _storage.Parquet, _storage.Index })
                {
                    <article>
                        <h3>@tier.Tier</h3>
                        <p>@FormatBytes(tier.TotalBytes) · @tier.FileCount files</p>
                        <p class="muted">Root: @tier.RootPath</p>
                        <ul>
                            @if (tier.Tenants.Count == 0)
                            {
                                <li class="muted">No active tenants.</li>
                            }
                            else
                            {
                                @foreach (var tenant in tier.Tenants)
                                {
                                    <li>@tenant.TenantId · @tenant.FileCount files · @FormatBytes(tenant.TotalBytes)</li>
                                }
                            }
                        </ul>
                    </article>
                }
            }
            else
            {
                <p class="status muted">Storage stats failed to load.</p>
            }
        </div>
    </section>

    <section>
        <h2>Graph Statistics</h2>
        <div class="graph-tenant-selector">
            @if (_graphTenants.Length > 0)
            {
                <label>
                    Tenant
                    <select class="graph-input" value="@_selectedGraphTenant" @onchange="OnGraphTenantSelectionChanged">
                        @foreach (var tenant in _graphTenants)
                        {
                            <option value="@tenant">@tenant</option>
                        }
                    </select>
                </label>
            }
            else
            {
                <p class="status muted">Import RDF to register tenant IDs.</p>
            }
        </div>
        @if (_graphStats is not null && !string.IsNullOrWhiteSpace(_selectedGraphTenant))
        {
            <p class="muted">Tenant: @_selectedGraphTenant</p>
            <table class="graph-stats-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Count</th>
                        <th>Samples (ID · Class)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var type in GraphStatOrder)
                    {
                        var samples = _graphStats.NodeSamples.TryGetValue(type, out var list) ? list : Array.Empty<GraphNodeDetail>();
                        <tr>
                            <td>@type</td>
                            <td class="numeric">@GetGraphStatCount(_graphStats, type)</td>
                            <td>
                                @if (samples.Count == 0)
                                {
                                    <span class="muted">No registered nodes</span>
                                }
                                else
                                {
                                    <ul>
                                        @foreach (var sample in samples)
                                        {
                                            <li>
                                                <strong>@sample.DisplayName</strong><br />
                                                <small>@sample.NodeId · @sample.NodeType</small>
                                            </li>
                                        }
                                    </ul>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p class="status muted">Graph statistics unavailable.</p>
        }
    </section>

    <section>
        <h2>Graph Hierarchy</h2>
        <button class="refresh-button" @onclick="LoadGraphHierarchyAsync" disabled="@string.IsNullOrWhiteSpace(_selectedGraphTenant)">Load Hierarchy</button>
        @if (string.IsNullOrWhiteSpace(_selectedGraphTenant))
        {
            <p class="status muted">Select a tenant.</p>
        }
        else if (_graphTreeNodes.Count > 0)
        {
            <div class="graph-tree-layout">
                <MudPaper Class="pa-3 graph-tree-panel">
                    <MudText Typo="Typo.subtitle1">Hierarchy Tree</MudText>
                    <MudTreeView T="GraphTreeNode" Hover="true" Class="graph-tree-view">
                        @RenderGraphTree(_graphTreeNodes)
                    </MudTreeView>
                </MudPaper>
                <MudPaper Class="pa-3 graph-tree-details">
                    <MudText Typo="Typo.subtitle1">Node Details</MudText>
                    @if (_selectedGraphNode is not null)
                    {
                        <MudText Typo="Typo.h6">@GetNodeLabel(_selectedGraphNode)</MudText>
                        <MudText Typo="Typo.body2"><strong>ID:</strong> @_selectedGraphNode.Node?.NodeId</MudText>
                        <MudText Typo="Typo.body2"><strong>Class:</strong> @NormalizeNodeType(_selectedGraphNode.Node?.NodeType ?? GraphNodeType.Unknown)</MudText>
                        <MudText Typo="Typo.subtitle2" Class="mt-2">Attributes</MudText>
                        @if ((_selectedGraphNode.Node?.Attributes?.Count ?? 0) == 0)
                        {
                            <MudText Typo="Typo.body2" Class="muted">No attributes.</MudText>
                        }
                        else
                        {
                            <MudList T="string" Dense="true">
                                @foreach (var attr in _selectedGraphNode.Node?.Attributes ?? new Dictionary<string, string>())
                                {
                                    <MudListItem T="string">@attr.Key: @attr.Value</MudListItem>
                                }
                            </MudList>
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Class="muted">Select a node to view details.</MudText>
                    }
                </MudPaper>
            </div>
        }
        else if (_loadingHierarchy)
        {
            <p class="status">Loading hierarchy...</p>
        }
        else
        {
            <p class="status muted">No hierarchy data available.</p>
        }
    </section>

    <section>
        <h2>Graph RDF Import</h2>
        <div class="graph-import-grid">
            <div class="graph-import">
                <label>
                    RDF path
                    <input class="graph-input" @bind="_graphPath" />
                </label>
                <label>
                    Tenant
                    <input class="graph-input" @bind="_graphTenant" />
                </label>
                <button class="refresh-button" @onclick="TriggerGraphSeedAsync" disabled="@_isImporting">
                    @_isImporting ? "Importing..." : "Run import"
                </button>
            </div>
            <div class="graph-status-card">
                <div class="graph-status-header">
                    <span>Last execution</span>
                    <span class="@GetGraphStatusBadgeClass(_graphStatus)">@GetGraphStatusLabel(_graphStatus)</span>
                </div>
                @if (_graphStatus is not null)
                {
                    <p class="graph-status-line">Path: @_graphStatus.Path</p>
                    <p class="graph-status-line">Tenant: @_graphStatus.TenantId</p>
                    <p class="graph-status-line">@_graphStatus.StartedAt:u · @_graphStatus.CompletedAt:u</p>
                    <p class="graph-status-line">Nodes: @_graphStatus.NodeCount · Edges: @_graphStatus.EdgeCount</p>
                    @if (!string.IsNullOrWhiteSpace(_graphStatus.Message))
                    {
                        <p class="graph-status-line status muted">Message: @_graphStatus.Message</p>
                    }
                }
                else
                {
                    <p class="graph-status-line muted">No graph seed history.</p>
                }
            </div>
        </div>
        @if (!string.IsNullOrWhiteSpace(_graphFeedback))
        {
            <p class="status">@_graphFeedback</p>
        }
    </section>
}

@code {
    private static readonly GraphNodeType[] GraphStatOrder = new[]
    {
        GraphNodeType.Site,
        GraphNodeType.Building,
        GraphNodeType.Level,
        GraphNodeType.Area,
        GraphNodeType.Equipment,
        GraphNodeType.Point
    };

    private GrainActivationSummary[] _grains = Array.Empty<GrainActivationSummary>();
    private SiloSummary[] _silos = Array.Empty<SiloSummary>();
    private StorageOverview? _storage;
    private IngestSummary? _ingest;
    private bool _loading = true;
    private string? _error;
    private string _graphPath = "/seed/seed.ttl";
    private string _graphTenant = "default";
    private GraphSeedStatus? _graphStatus;
    private bool _isImporting;
    private string? _graphFeedback;
    private string[] _graphTenants = Array.Empty<string>();
    private string? _selectedGraphTenant;
    private GraphStatisticsSummary? _graphStats;
    private List<GraphTreeNode> _graphTreeNodes = new();
    private GraphNodeSnapshot? _selectedGraphNode;
    private bool _loadingHierarchy;

    protected override async Task OnInitializedAsync()
    {
        await RefreshAsync();
    }

    private async Task RefreshAsync()
    {
        _loading = true;
        _error = null;
        try
        {
            _grains = await Metrics.GetGrainActivationsAsync();
            _silos = await Metrics.GetSiloSummariesAsync();
            _storage = await Metrics.GetStorageOverviewAsync(CancellationToken.None);
            _ingest = Metrics.GetIngestSummary();
            _graphStatus = await Metrics.GetLastGraphSeedStatusAsync();
            await LoadGraphTenantOptionsAsync();
            await LoadGraphStatisticsAsync();
        }
        catch (Exception ex)
        {
            _error = $"Failed to load dashboard data: {ex.Message}";
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadGraphHierarchyAsync()
    {
        if (string.IsNullOrWhiteSpace(_selectedGraphTenant))
        {
            _graphTreeNodes.Clear();
            _selectedGraphNode = null;
            return;
        }

        _loadingHierarchy = true;
        try
        {
            _graphTreeNodes = (await Metrics.GetGraphTreeAsync(_selectedGraphTenant)).ToList();
            _selectedGraphNode = null;
        }
        catch (Exception ex)
        {
            _error = $"Failed to load hierarchy: {ex.Message}";
        }
        finally
        {
            _loadingHierarchy = false;
            StateHasChanged();
        }
    }

    private async Task LoadGraphTenantOptionsAsync()
    {
        var tenants = await Metrics.GetGraphTenantsAsync();
        _graphTenants = tenants ?? Array.Empty<string>();

        if (_graphTenants.Length == 0)
        {
            _selectedGraphTenant = null;
            return;
        }

        if (string.IsNullOrWhiteSpace(_selectedGraphTenant) ||
            !Array.Exists(_graphTenants, tenant => string.Equals(tenant, _selectedGraphTenant, StringComparison.OrdinalIgnoreCase)))
        {
            _selectedGraphTenant = _graphTenants[0];
        }

        if (string.Equals(_graphTenant, "default", StringComparison.OrdinalIgnoreCase) &&
            !string.IsNullOrWhiteSpace(_selectedGraphTenant))
        {
            _graphTenant = _selectedGraphTenant;
        }
    }

    private async Task LoadGraphStatisticsAsync()
    {
        if (string.IsNullOrWhiteSpace(_selectedGraphTenant))
        {
            _graphStats = null;
            return;
        }

        _graphStats = await Metrics.GetGraphStatisticsAsync(_selectedGraphTenant);
    }

    private async Task OnGraphTenantSelectionChanged(ChangeEventArgs args)
    {
        if (args?.Value is not string tenant || string.IsNullOrWhiteSpace(tenant))
        {
            return;
        }

        _selectedGraphTenant = tenant;
        await LoadGraphStatisticsAsync();
        _graphTreeNodes.Clear();
        _selectedGraphNode = null;
        StateHasChanged();
    }

    private static int GetGraphStatCount(GraphStatisticsSummary stats, GraphNodeType type)
        => type switch
        {
            GraphNodeType.Site => stats.SiteCount,
            GraphNodeType.Building => stats.BuildingCount,
            GraphNodeType.Level => stats.LevelCount,
            GraphNodeType.Area => stats.AreaCount,
            GraphNodeType.Equipment => stats.EquipmentCount,
            GraphNodeType.Point => stats.PointCount,
            _ => 0
        };

    private RenderFragment RenderGraphTree(IReadOnlyList<GraphTreeNode> nodes) => builder =>
    {
        var sequence = 0;
        foreach (var node in nodes)
        {
            builder.OpenComponent<MudTreeViewItem<GraphTreeNode>>(sequence++);
            builder.AddAttribute(sequence++, "Value", node);
            builder.AddAttribute(sequence++, "Text", node.DisplayName);
            builder.AddAttribute(sequence++, "Icon", GetTreeIcon(node.NodeType));
            builder.AddAttribute(sequence++, "CanExpand", node.Children.Count > 0);
            builder.AddAttribute(sequence++, "OnClick", EventCallback.Factory.Create<MouseEventArgs>(this, _ => SelectGraphNodeAsync(node.NodeId)));
            if (node.Children.Count > 0)
            {
                builder.AddAttribute(sequence++, "ChildContent", RenderGraphTree(node.Children));
            }
            builder.CloseComponent();
        }
    };

    private async Task SelectGraphNodeAsync(string nodeId)
    {
        if (string.IsNullOrWhiteSpace(nodeId) || string.IsNullOrWhiteSpace(_selectedGraphTenant))
        {
            _selectedGraphNode = null;
            return;
        }

        _selectedGraphNode = await Metrics.GetGraphNodeAsync(_selectedGraphTenant, nodeId);
        StateHasChanged();
    }

    private static string GetTreeIcon(GraphNodeType type)
        => type switch
        {
            GraphNodeType.Site => Icons.Material.Filled.Public,
            GraphNodeType.Building => Icons.Material.Filled.HomeWork,
            GraphNodeType.Level => Icons.Material.Filled.Layers,
            GraphNodeType.Area => Icons.Material.Filled.Map,
            GraphNodeType.Equipment => Icons.Material.Filled.Memory,
            GraphNodeType.Device => Icons.Material.Filled.Memory,
            GraphNodeType.Point => Icons.Material.Filled.ControlPoint,
            _ => Icons.Material.Filled.DeviceHub
        };

    private static GraphNodeType NormalizeNodeType(GraphNodeType type)
        => type == GraphNodeType.Device ? GraphNodeType.Equipment : type;

    private static string GetNodeLabel(GraphNodeSnapshot? snapshot)
    {
        if (snapshot?.Node is not { } node)
        {
            return "(unknown)";
        }

        return !string.IsNullOrWhiteSpace(node.DisplayName) ? node.DisplayName : node.NodeId;
    }

    private static string FormatBytes(long? bytes) => FormatBytes((double?)bytes);

    private static string FormatBytes(double? bytes)
    {
        if (!bytes.HasValue)
        {
            return "-";
        }

        var value = bytes.Value;
        var units = new[] { "B", "KB", "MB", "GB", "TB" };
        var index = 0;
        while (value >= 1024 && index < units.Length - 1)
        {
            value /= 1024;
            index++;
        }

        return $"{value:F1} {units[index]}";
    }

    private static string FormatPercent(double? value)
        => value.HasValue ? $"{value.Value:F1}%" : "-";

    private static string FormatMemoryUsage(double? used, double? available)
    {
        if (!used.HasValue && !available.HasValue)
        {
            return "-";
        }

        var usedText = FormatBytes(used);
        if (!available.HasValue)
        {
            return usedText;
        }

        return $"{usedText} / {FormatBytes(available)}";
    }

    private static string GetGraphStatusLabel(GraphSeedStatus? status)
        => status is null ? "Not run" : status.Success ? "Success" : "Failure";

    private static string GetGraphStatusBadgeClass(GraphSeedStatus? status)
        => status is null ? "status-badge muted" : status.Success ? "status-badge success" : "status-badge failure";

    private async Task TriggerGraphSeedAsync()
    {
        _isImporting = true;
        _graphFeedback = null;
        try
        {
            var request = new GraphSeedRequest(_graphPath, _graphTenant);
            var result = await Metrics.TriggerGraphSeedAsync(request);
            _graphStatus = result;
            _graphFeedback = result.Success
                ? "Import completed."
                : $"Import failed: {result.Message ?? "Unknown error"}";
        }
        catch (Exception ex)
        {
            _graphFeedback = $"Import failed: {ex.Message}";
        }
        finally
        {
            _isImporting = false;
        }
    }
}
