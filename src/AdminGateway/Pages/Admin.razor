@page "/"
@inject AdminMetricsService Metrics

<section class="admin-header">
    <div>
        <p class="eyebrow">Orleans Telemetry - ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</p>
        <h1>Cluster Overview</h1>
    </div>
    <button class="refresh-button" @onclick="RefreshAsync">ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>
</section>

@if (_loading)
{
    <p class="status">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
}
else if (_error is not null)
{
    <p class="status error">@_error</p>
}
else
{
    <section class="overview">
        <article>
            <h2>Ingest</h2>
            <p>ãƒãƒƒãƒã‚µã‚¤ã‚º: @_ingest?.BatchSize</p>
            <p>ãƒãƒ£ãƒãƒ«å®¹é‡: @_ingest?.ChannelCapacity</p>
            <div class="tag-row">
                <strong>Connectors</strong>
                @if (_ingest?.EnabledConnectors.Length > 0)
                {
                    @foreach (var connector in _ingest.EnabledConnectors)
                    {
                        <span class="tag">@connector</span>
                    }
                }
                else
                {
                    <span class="tag muted">æœªæ§‹æˆ</span>
                }
            </div>
            <div class="tag-row">
                <strong>Event sinks</strong>
                @if (_ingest?.EnabledSinks.Length > 0)
                {
                    @foreach (var sink in _ingest.EnabledSinks)
                    {
                        <span class="tag">@sink</span>
                    }
                }
                else
                {
                    <span class="tag muted">æœªæ§‹æˆ</span>
                }
            </div>
        </article>
        <article>
            <h2>Storage</h2>
            @if (_storage is not null)
            {
                <p>Stage: @_storage.Stage.FileCount files</p>
                <p>Parquet: @_storage.Parquet.FileCount files</p>
                <p>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: @_storage.Index.FileCount files</p>
            }
            else
            {
                <p>Storage stats unavailable.</p>
            }
        </article>
        <article>
            <h2>Clients</h2>
            <p>Silodis: @_silos.Length</p>
            <p>åˆè¨ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: @(_silos.Sum(s => s.ClientCount))</p>
        </article>
    </section>

    <section>
        <h2>Activation Explorer (@_grains.Length types)</h2>
        @if (_grains.Length == 0)
        {
            <p class="status muted">ã‚°ãƒ¬ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        }
        else
        {
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th>Grain Type</th>
                            <th>Activations</th>
                            <th>Silod</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var grain in _grains)
                        {
                            <tr>
                                <td>@grain.GrainType</td>
                                <td class="numeric">@grain.ActivationCount</td>
                                <td>@string.Join(", ", grain.Silos)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </section>

    <section>
        <h2>Client Connections</h2>
        @if (_silos.Length == 0)
        {
            <p class="status muted">ã‚·ãƒ­çµ±è¨ˆãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚</p>
        }
        else
        {
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th>Silo</th>
                            <th>Status</th>
                            <th>Clients</th>
                            <th>Activations</th>
                            <th>CPU (%)</th>
                            <th>Memory (used / max)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var silo in _silos)
                        {
                            <tr>
                                <td>@silo.SiloAddress</td>
                                <td>@silo.Status</td>
                                <td class="numeric">@silo.ClientCount</td>
                                <td class="numeric">@silo.ActivationCount</td>
                                <td>@FormatPercent(silo.CpuUsagePercentage)</td>
                                <td>@FormatMemoryUsage(silo.MemoryUsageBytes, silo.MaximumAvailableMemoryBytes)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </section>

    <section>
        <h2>Storage Buckets</h2>
        <div class="tier-grid">
            @if (_storage is not null)
            {
                @foreach (var tier in new[] { _storage.Stage, _storage.Parquet, _storage.Index })
                {
                    <article>
                        <h3>@tier.Tier</h3>
                        <p>@FormatBytes(tier.TotalBytes) Â· @tier.FileCount files</p>
                        <p class="muted">ãƒ«ãƒ¼ãƒˆ: @tier.RootPath</p>
                        <ul>
                            @if (tier.Tenants.Count == 0)
                            {
                                <li class="muted">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ†ãƒŠãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>
                            }
                            else
                            {
                                @foreach (var tenant in tier.Tenants)
                                {
                                    <li>@tenant.TenantId Â· @tenant.FileCount files Â· @FormatBytes(tenant.TotalBytes)</li>
                                }
                            }
                        </ul>
                    </article>
                }
            }
            else
            {
                <p class="status muted">Storage stats failed to load.</p>
            }
        </div>
    </section>
    <section>
        <h2>Graph Statistics</h2>
        @if (_graphStats is not null)
        {
            <div class="tier-grid">
                <article>
                    <h3>Site</h3>
                    <p class="stat-value">@_graphStats.SiteCount</p>
                </article>
                <article>
                    <h3>Building</h3>
                    <p class="stat-value">@_graphStats.BuildingCount</p>
                </article>
                <article>
                    <h3>Level</h3>
                    <p class="stat-value">@_graphStats.LevelCount</p>
                </article>
                <article>
                    <h3>Area</h3>
                    <p class="stat-value">@_graphStats.AreaCount</p>
                </article>
                <article>
                    <h3>Equipment</h3>
                    <p class="stat-value">@_graphStats.EquipmentCount</p>
                </article>
                <article>
                    <h3>Point</h3>
                    <p class="stat-value">@_graphStats.PointCount</p>
                </article>
            </div>
        }
        else
        {
            <p class="status muted">Graph statistics unavailable.</p>
        }
    </section>

    <section>
        <h2>Graph Hierarchy</h2>
        <button class="refresh-button" @onclick="LoadGraphHierarchyAsync">éšå±¤ã‚’èª­ã¿è¾¼ã‚€</button>
        @if (_graphHierarchy is not null && _graphHierarchy.Nodes.Count > 0)
        {
            <div class="graph-tree">
                @foreach (var building in _graphHierarchy.Nodes.Where(n => n.Node.NodeType == GraphNodeType.Building))
                {
                    <div class="tree-node building">
                        <strong>ğŸ¢ @building.Node.DisplayName</strong>
                        @foreach (var levelEdge in building.OutgoingEdges.Where(e => e.Predicate == "hasLevel"))
                        {
                            <div class="tree-node level">
                                ğŸ“ Level: @levelEdge.TargetNodeId
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else if (_loadingHierarchy)
        {
            <p class="status">éšå±¤ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        }
        else
        {
            <p class="status muted">éšå±¤ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        }
    </section>

    <section>
        <h2>Graph RDF Import</h2>
        <div class="graph-import-grid">
            <div class="graph-import">
                <label>
                    RDF path
                    <input class="graph-input" @bind="_graphPath" />
                </label>
                <label>
                    Tenant
                    <input class="graph-input" @bind="_graphTenant" />
                </label>
                <button class="refresh-button" @onclick="TriggerGraphSeedAsync" disabled="@_isImporting">
                    @_isImporting ? "å®Ÿè¡Œä¸­..." : "ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ"
                </button>
            </div>
            <div class="graph-status-card">
                <div class="graph-status-header">
                    <span>Last execution</span>
                    <span class="@GetGraphStatusBadgeClass(_graphStatus)">@GetGraphStatusLabel(_graphStatus)</span>
                </div>
                @if (_graphStatus is not null)
                {
                    <p class="graph-status-line">ãƒ‘ã‚¹: @_graphStatus.Path</p>
                    <p class="graph-status-line">ãƒ†ãƒŠãƒ³ãƒˆ: @_graphStatus.TenantId</p>
                    <p class="graph-status-line">@_graphStatus.StartedAt:u â†’ @_graphStatus.CompletedAt:u</p>
                    <p class="graph-status-line">ãƒãƒ¼ãƒ‰: @_graphStatus.NodeCount Â· ã‚¨ãƒƒã‚¸: @_graphStatus.EdgeCount</p>
                    @if (!string.IsNullOrWhiteSpace(_graphStatus.Message))
                    {
                        <p class="graph-status-line status muted">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: @_graphStatus.Message</p>
                    }
                }
                else
                {
                    <p class="graph-status-line muted">Graph seed ã®å®Ÿè¡Œå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                }
            </div>
        </div>
        @if (!string.IsNullOrWhiteSpace(_graphFeedback))
        {
            <p class="status">@_graphFeedback</p>
        }
    </section>
}

@code {
    private GrainActivationSummary[] _grains = Array.Empty<GrainActivationSummary>();
    private SiloSummary[] _silos = Array.Empty<SiloSummary>();
    private StorageOverview? _storage;
    private IngestSummary? _ingest;
    private bool _loading = true;
    private string? _error;
    private string _graphPath = "/seed/seed.ttl";
    private string _graphTenant = "default";
    private GraphSeedStatus? _graphStatus;
    private bool _isImporting;
    private string? _graphFeedback;
    private GraphStatisticsSummary? _graphStats;
    private GraphNodeHierarchy? _graphHierarchy;
    private bool _loadingHierarchy;

    protected override async Task OnInitializedAsync()
    {
        await RefreshAsync();
    }

    private async Task RefreshAsync()
    {
        _loading = true;
        _error = null;
        try
        {
            _grains = await Metrics.GetGrainActivationsAsync();
            _silos = await Metrics.GetSiloSummariesAsync();
            _storage = await Metrics.GetStorageOverviewAsync(CancellationToken.None);
            _ingest = Metrics.GetIngestSummary();
            _graphStatus = await Metrics.GetLastGraphSeedStatusAsync();
            _graphStats = await Metrics.GetGraphStatisticsAsync();
        }
        catch (Exception ex)
        {
            _error = $"èª­ã¿è¾¼ã¿ã«å¤±æ•—: {ex.Message}";
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadGraphHierarchyAsync()
    {
        _loadingHierarchy = true;
        try
        {
            _graphHierarchy = await Metrics.GetGraphHierarchyAsync();
        }
        catch (Exception ex)
        {
            _error = $"éšå±¤èª­ã¿è¾¼ã¿ã«å¤±æ•—: {ex.Message}";
        }
        finally
        {
            _loadingHierarchy = false;
            StateHasChanged();
        }
    }

    private static string FormatBytes(long? bytes) => FormatBytes((double?)bytes);

    private static string FormatBytes(double? bytes)
    {
        if (!bytes.HasValue)
        {
            return "-";
        }

        var value = bytes.Value;
        var units = new[] { "B", "KB", "MB", "GB", "TB" };
        var index = 0;
        while (value >= 1024 && index < units.Length - 1)
        {
            value /= 1024;
            index++;
        }

        return $"{value:F1} {units[index]}";
    }

    private static string FormatPercent(double? value)
        => value.HasValue ? $"{value.Value:F1}%" : "-";

    private static string FormatMemoryUsage(double? used, double? available)
    {
        if (!used.HasValue && !available.HasValue)
        {
            return "-";
        }

        var usedText = FormatBytes(used);
        if (!available.HasValue)
        {
            return usedText;
        }

        return $"{usedText} / {FormatBytes(available)}";
    }

    private static string GetGraphStatusLabel(GraphSeedStatus? status)
        => status is null ? "æœªå®Ÿè¡Œ" : status.Success ? "æˆåŠŸ" : "å¤±æ•—";

    private static string GetGraphStatusBadgeClass(GraphSeedStatus? status)
        => status is null ? "status-badge muted" : status.Success ? "status-badge success" : "status-badge failure";

    private async Task TriggerGraphSeedAsync()
    {
        _isImporting = true;
        _graphFeedback = null;
        try
        {
            var request = new GraphSeedRequest(_graphPath, _graphTenant);
            var result = await Metrics.TriggerGraphSeedAsync(request);
            _graphStatus = result;
            _graphFeedback = result.Success ? "ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚" : $"å¤±æ•—: {result.Message ?? "æœªçŸ¥ã®ã‚¨ãƒ©ãƒ¼"}";
        }
        catch (Exception ex)
        {
            _graphFeedback = $"ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ä¾‹å¤–: {ex.Message}";
        }
        finally
        {
            _isImporting = false;
        }
    }
}
